---

## **기능명세서: 22. 난이도 곡선 및 밸런스 튜닝 (지원 시스템)**

**개발 우선순위:** Phase 1 부터 지속적 관리 필요 (관련 데이터 테이블), Phase 4 (어드민 UI/기능 구현) - 난이도: 어려움 (지속적 작업)

### **프론트엔드 기능명세서 (Admin Panel 내)**

1.  **화면 레이아웃 및 디자인 명세**:
    *   **밸런스 데이터 관리 UI (어드민 시스템 - 게임 데이터 관리 확장)**:
        *   `/admin/game-data/{dataType}` (예: `/items`, `/monsters`, `/stages`, `/levels`, `/skills` 등) 페이지에서 관련 데이터 관리.
        *   **테이블 기반 데이터 편집:**
            *   각 데이터 타입(아이템, 몬스터 등)의 목록을 `DataTable`로 표시. 주요 밸런스 관련 수치(공격력, HP, 요구 경험치, 스킬 계수, 강화 비용/확률 등) 컬럼 포함.
            *   인라인 편집 기능 또는 행 클릭 시 상세 편집 `Dialog` 폼 제공.
            *   대량 데이터 수정을 위한 CSV 업로드/다운로드 기능 제공 고려 (별도 라이브러리 필요).
            *   검색 및 필터링 기능 강화 (예: 특정 레벨 구간 몬스터, 특정 등급 아이템 필터링).
        *   **시각화 도구 (`app/admin/balance-visualization/page.tsx`)**:
            *   **레벨별 요구 경험치 그래프:** `game_level_requirements.required_exp` 데이터를 차트로 시각화하여 레벨업 속도 곡선 확인. (Recharts 등 차트 라이브러리 사용)
            *   **스테이지별 몬스터 스펙 그래프:** `game_stages`와 `game_monsters` 데이터를 기반으로, 스테이지 진행에 따른 평균 몬스터 HP/공격력 변화 추이 시각화.
            *   **아이템 등급/강화별 성능 그래프:** `game_items`, `game_enhancement_rules` 데이터를 기반으로 등급/강화 단계에 따른 주요 스탯(예: 공격력) 증가 추이 시각화.
            *   **ShadCN 컴포넌트 활용:** 페이지 레이아웃, 테이블(`DataTable`), 버튼, 폼 요소 등. 차트 표시는 외부 라이브러리 컴포넌트 활용.
        *   **파일 위치:** 기존 `app/admin/game-data/...` 페이지들 수정/확장, 신규 `app/admin/balance-visualization/page.tsx`, 관련 테이블 및 차트 컴포넌트.
    *   **밸런스 테스트 지원 기능 (어드민 시스템 - 사용자 관리 또는 별도 메뉴)**:
        *   특정 사용자 계정을 '테스트 계정'으로 지정하고, 해당 계정의 레벨, 보유 재화, 아이템, 스킬 등을 임의로 설정하는 기능.
        *   (고급) 특정 조건(레벨, 직업, 장비 세팅)에서의 전투 결과를 시뮬레이션하고 예상 DPS, 생존 시간 등을 보여주는 기능 (구현 난이도 매우 높음).
        *   **ShadCN 컴포넌트 활용:** `Dialog`, `Form`, `Input`, `Select`, `Button`.

2.  **사용자 흐름 및 상호작용 (어드민)**:
    *   밸런스 담당자는 어드민 패널에 로그인하여 '게임 데이터 관리' 또는 '밸런스 시각화' 메뉴 접근.
    *   데이터 테이블을 통해 특정 아이템, 몬스터, 스테이지 등의 수치 직접 조회 및 수정.
    *   시각화 도구를 통해 레벨업 곡선, 난이도 상승 추세 등 전반적인 밸런스 현황 파악.
    *   필요시 CSV로 데이터 export 하여 외부 툴에서 분석하거나, 수정된 데이터를 import 하여 일괄 적용.
    *   테스트 지원 기능을 사용하여 특정 조건의 캐릭터를 만들고 실제 게임 플레이를 통해 밸런스 체감 확인.
    *   수정된 데이터를 저장하고, 필요시 게임 서버에 반영 (데이터 업데이트 방식 정의 필요 - 예: 즉시 반영, 점검 후 반영).

3.  **API 연동**:
    *   **게임 데이터 CRUD API (`/api/admin/game-data/{dataType}/...`)**: 밸런스 관련 수치 수정 기능과 연동. (기존 어드민 API 명세 참조)
    *   **시각화용 데이터 API (`/api/admin/balance-data/...`)**: 차트 표시에 필요한 집계/가공된 데이터 제공 API (예: 레벨별 경험치 목록, 스테이지별 몬스터 스펙 요약).
    *   **테스트 지원 API (`/api/admin/test-support/...`)**: 테스트 계정 상태 설정 API 등.

4.  **테스트 항목 (어드민 UI)**:
    *   밸런스 데이터(수치) 조회 및 수정 UI가 정상 작동하는지 확인. CSV 업/다운로드 기능 확인 (구현 시).
    *   데이터 유효성 검증(예: 음수 입력 불가)이 프론트엔드 레벨에서도 작동하는지 확인.
    *   시각화 차트가 정확한 데이터를 기반으로 올바르게 그려지는지 확인.
    *   테스트 지원 기능(계정 상태 설정 등)이 정상 작동하는지 확인.
    *   모든 변경 사항이 관련 API를 통해 백엔드에 올바르게 전달되는지 확인.

---

### **백엔드 기능명세서**

1.  **API 정의**:
    *   **게임 데이터 관리 API (`app/api/admin/game-data/{dataType}/...`) 확장**:
        *   **CRUD 핸들러:** 각 데이터 타입(몬스터, 스테이지, 레벨 등)의 CRUD API 핸들러는 밸런스 관련 수치(숫자, JSONB 내 값 등) 수정 로직 포함.
        *   **데이터 유효성 검증 강화:** API 레벨에서 수정되는 데이터의 유효 범위(예: 확률값 0~1, 레벨 경험치 양수) 등을 검증하는 로직 필수 포함. 잘못된 데이터 입력 시 에러 반환.
        *   **대량 수정 지원 (선택적):** CSV 업로드/다운로드 지원 시, 관련 API 엔드포인트 및 처리 로직 구현.
    *   **시각화용 데이터 API (`app/api/admin/balance-data/...`)**:
        *   `GET /levels/exp`: `game_level_requirements` 테이블에서 레벨별 `required_exp` 목록 반환.
        *   `GET /stages/difficulty`: `game_stages`와 `game_monsters`를 조인/집계하여 스테이지 순서별 평균 몬스터 HP/공격력 등 계산하여 반환.
        *   (기타 필요한 시각화 데이터 API 정의)
    *   **테스트 지원 API (`app/api/admin/test-support/...`)**:
        *   `POST /set-character-state`: 특정 사용자의 레벨, 재화, 아이템, 스킬 등을 요청된 값으로 강제 설정하는 API (매우 주의해서 사용해야 함). 대상 계정 검증 및 권한 확인 필수.
    *   **모든 관리 API:** 어드민 권한 검증 및 액션 로그(`admin_logs`) 기록 필수.

2.  **데이터베이스 설계 및 연동**:
    *   **밸런스 핵심 테이블 목록:** (이 테이블들의 데이터가 튜닝 대상)
        *   `game_level_requirements`: `required_exp`.
        *   `game_stages`: `required_power`, 몬스터 배치 정보, 클리어 보상 (`reward_gold`, `reward_exp`, `repeat_clear_reward_essence` 등).
        *   `game_monsters`: `hp`, `attack_power`, `defense`, `exp_reward`, `gold_reward`, 드랍 테이블 연동.
        *   `game_items`: `base_stats`, `unique_options` 생성 규칙, `sell_price`, `set_id`.
        *   `game_item_sets`: `effects` (스탯, 특수 효과).
        *   `game_skills`: `base_effect`, `level_scaling`, `cooldown_ms`, `mana_cost`.
        *   `game_enhancement_rules`: `cost_gold`, `success_chance`.
        *   `game_relics`: `base_effect`, `level_scaling`, 강화 비용/확률.
        *   `game_jobs`: `base_stats_modifier`, `stats_per_level`.
        *   `game_adventure_zones`: `resource_bonus_multiplier`, 등장 몬스터, `required_power`.
    *   **연동 로직:** 어드민 API 핸들러 내에서 Supabase 클라이언트 사용하여 해당 테이블 데이터 조회/수정. 데이터 유효성 검증 로직 중요. `admin_logs` 테이블에 변경 이력 기록.

3.  **테스트 항목 (백엔드)**:
    *   각 게임 데이터 관리 API가 밸런스 수치를 포함하여 CRUD를 올바르게 수행하는지 확인.
    *   API 레벨에서의 데이터 유효성 검증(범위, 타입 등)이 제대로 작동하여 잘못된 데이터 입력을 막는지 확인.
    *   시각화용 데이터 API가 정확하고 필요한 형식의 데이터를 반환하는지 확인.
    *   테스트 지원 API가 대상 계정 상태를 의도대로 변경하는지, 권한 검증이 작동하는지 확인.
    *   모든 데이터 변경 작업이 `admin_logs`에 기록되는지 확인.
    *   대량 데이터 조회/수정 시 DB 성능(인덱스 활용 등) 확인.

4.  **밸런스 데이터 관리 전략**:
    *   **버전 관리:** 게임 데이터(특히 밸런스 관련)는 버전 관리 시스템(Git 등)을 사용하여 변경 이력을 추적하고, 특정 버전으로 롤백 가능하도록 관리하는 것이 좋음 (예: DB 마이그레이션 스크립트 관리).
    *   **테스트 환경:** 실제 서비스 환경과 분리된 테스트 환경에서 밸런스 변경 사항을 충분히 검증한 후 라이브 환경에 적용.
    *   **데이터 백업:** 정기적인 DB 백업 필수.

---
