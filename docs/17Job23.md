---

## **기능명세서: 17. 직업 시스템 (2차/3차 전직)**

**개발 우선순위:** Phase 4 (심화 콘텐츠 및 운영 도구) - 난이도: 어려움

### **프론트엔드 기능명세서**

1.  **화면 레이아웃 및 디자인 명세**:
    *   **캐릭터 정보 화면 - 직업 표시 (`app/character/page.tsx` 또는 관련 컴포넌트)**:
        *   현재 캐릭터의 직업 이름, 아이콘/일러스트 표시 시 **직업 티어(예: 2차, 3차)**를 명확하게 표시하도록 업데이트. (기존 UI 컴포넌트 활용)
        *   **파일 위치:** `app/character/page.tsx` 또는 `app/character/CharacterInfoPanel.tsx`.
    *   **전직 화면 (`app/job-change/page.tsx` 또는 `components/features/JobChangeDialog.tsx`)**:
        *   **접근 조건:** Lv 200 (2차 전직), Lv 500 (3차 전직) 도달 시 접근 가능하도록 변경.
        *   **UI 구조 확장:**
            *   현재 직업(1차 또는 2차) 정보 표시.
            *   전직 가능한 상위 직업(2차 또는 3차) 목록 표시. (UI 구조는 1차 전직과 유사하게 재활용, `Card` 등 사용)
            *   각 상위 직업 정보(아이콘, 이름, 특징, 주요 신규 스킬/패시브 요약) 표시 업데이트.
            *   "이 직업으로 전직" 버튼 로직 동일.
        *   **ShadCN 컴포넌트 활용:** 기존과 동일하게 `Dialog`, `Card`, `Button`, `Tabs` (전직 트리 시각화 시), `Avatar`, `AlertDialog` 활용.
        *   **파일 위치:** `app/job-change/page.tsx` 또는 `components/features/JobChangeDialog.tsx`.
    *   **레벨업 알림 (`app/dashboard/page.tsx` 또는 `components/common/Notifications.tsx`)**:
        *   Lv 200, Lv 500 도달 시 각각 "Lv 200 달성! 2차 전직이 가능합니다!", "Lv 500 달성! 3차 전직이 가능합니다!" 알림 메시지 표시. (기존 알림 시스템 활용)
        *   알림 클릭 시 전직 화면 이동 링크 제공.
        *   **ShadCN 컴포넌트 활용:** `Toast` 또는 `Alert` 컴포넌트 활용.

2.  **사용자 흐름 및 상호작용**:
    *   **레벨업:** 캐릭터가 Lv 200, Lv 500 도달.
    *   **전직 가능 알림:** 해당 레벨 도달 시 알림 발생.
    *   **전직 화면 접근:** 알림 클릭 또는 메뉴 통해 전직 화면 이동.
    *   **직업 선택:** 전직 화면에서 상위 티어(2차 또는 3차) 직업 중 하나 선택. 정보 확인.
    *   **전직 실행:** "이 직업으로 전직" 버튼 클릭 > 확인 `AlertDialog` > '확인' 클릭.
    *   **전직 완료:**
        *   캐릭터 정보의 직업 정보(이름, 아이콘, 티어) 업데이트.
        *   직업 변경에 따른 스탯 변화 반영.
        *   새로운 직업 전용 스킬/패시브 자동 습득 또는 습득 가능 상태 변경 (기능 8 연계).
        *   UI 업데이트.
    *   **전직 불가:** 요구 레벨 미달 시 전직 버튼 비활성화 또는 진행 불가 처리. 이미 해당 티어 전직 완료 시 버튼 비활성화 또는 메시지 표시.

3.  **API 연동**:
    *   **캐릭터 정보 로드:** 현재 직업 ID, 레벨, 티어 정보 포함하여 로드.
    *   **전직 가능 직업 목록 로드:** 현재 직업 ID 및 티어를 기반으로 전직 가능한 상위 직업 목록(`game_jobs`) 조회.
    *   **Server Action 호출:** `changeJob(targetJobId: string)` (기존 Action 재활용, 백엔드에서 레벨 및 유효 경로, 티어 검증 강화).

4.  **테스트 항목**:
    *   Lv 200, 500 도달 시 전직 알림이 정상적으로 표시되는지 확인.
    *   전직 화면 접근 시 현재 직업 기준 올바른 상위 티어 직업 목록이 표시되는지 확인.
    *   요구 레벨(200, 500) 미달 시 전직 버튼 비활성화 또는 진행 불가 처리 확인.
    *   이미 해당 티어 전직을 완료한 경우 추가 진행 불가 처리 확인.
    *   2차, 3차 전직 실행 및 완료 후 캐릭터 정보 UI(직업명, 티어)가 올바르게 업데이트되는지 확인.
    *   전직 후 관련 신규 스킬 상태가 업데이트되는지 확인 (백엔드 연동 후).

---

### **백엔드 기능명세서**

1.  **API 정의**:
    *   **직업 정보 제공 API (기존 API 확장)**:
        *   **목적:** 클라이언트에 특정 직업 기반의 상위 티어 전직 트리 정보 제공.
        *   **처리 로직:** `game_jobs` 테이블 조회 시, 요청된 직업 ID의 `tier`와 `next_job_options` 필드를 사용하여 다음 단계(2차 또는 3차) 전직 가능한 직업 목록 정보를 필터링하여 반환.
    *   **Server Action `changeJob(targetJobId: string)` (기존 Action 수정/확장)**:
        *   **파일 위치:** `actions/character.ts` (또는 `actions/job.ts`)
        *   **처리 로직 수정/강화:**
            1.  사용자 인증 확인 (기존 동일).
            2.  `user_characters` 테이블에서 현재 사용자 정보(레벨, 현재 `job_id`) 조회 (기존 동일).
            3.  `game_jobs` 테이블에서 현재 직업 정보(`currentJob`) 및 `targetJobId` 직업 정보(`targetJob`) 조회 (기존 동일). `tier`, `required_level`, `next_job_options` 정보 포함.
            4.  **조건 검증 강화:**
                *   사용자 레벨(`user_characters.level`) >= `targetJob.required_level` (200 또는 500) 인가?
                *   `targetJobId`가 `currentJob.next_job_options` 목록에 포함되어 있는가?
                *   `targetJob.tier`가 `currentJob.tier` + 1 인가? (중복/건너뛰기 방지)
                *   (선택적) 이미 `targetJob.tier` 이상의 직업을 가지고 있지 않은가? (예방적 검증)
            5.  **트랜잭션 로직:** (기존과 동일)
                *   `user_characters` 테이블의 `job_id`를 `targetJobId`로 업데이트.
                *   스탯 보정치 적용.
                *   자동 습득 스킬 처리 (`targetJob.auto_learn_skills_on_change` 기반으로 `user_skills` 삽입).
            6.  **트랜잭션 종료.** (기존 동일)
            7.  성공/실패 결과 반환. `revalidatePath` 호출. (기존 동일)

2.  **데이터베이스 설계 및 연동**:
    *   **`game_jobs` 테이블 수정/데이터 추가**:
        *   **데이터 추가:** 2차, 3차 직업들에 대한 레코드 추가 (ID, 이름, 설명, `tier`=2 or 3, 아이콘, `required_level`=200 or 500 등).
        *   **관계 설정:**
            *   1차 직업 레코드의 `next_job_options` 필드에 해당 2차 직업 ID 목록 입력.
            *   2차 직업 레코드의 `next_job_options` 필드에 해당 3차 직업 ID 목록 입력. (3차 직업은 `next_job_options`가 null 또는 빈 배열)
        *   **필드 채우기:** 각 2차/3차 직업의 `base_stats_modifier`, `job_specific_skills`, `auto_learn_skills_on_change` 등 관련 필드 데이터 입력.
    *   **`game_skills` 테이블 데이터 추가**:
        *   2차, 3차 직업에서 사용될 새로운 고유 스킬(액티브/패시브) 데이터 추가 (`id`, `name`, `description`, 효과, 스케일링 등).
    *   **`user_characters`, `user_skills` 테이블**: 스키마 변경 없음. 데이터 업데이트 대상.
    *   **연동 로직:** 수정/확장된 Server Action 내에서 Supabase 클라이언트 사용. 기존 트랜잭션 로직(DB 함수) 활용/확장.

3.  **테스트 항목**:
    *   직업 정보 API가 2차, 3차 전직 경로를 포함하여 정확한 데이터를 반환하는지 확인.
    *   `changeJob` 액션:
        *   Lv 200, Lv 500 요구 레벨 조건 검증이 올바르게 작동하는지 확인.
        *   유효한 다음 티어 직업 경로 검증이 올바르게 작동하는지 확인.
        *   이미 상위 티어로 전직한 경우 추가 전직 시도가 실패 처리되는지 확인.
        *   2차, 3차 전직 성공 시 `user_characters.job_id`가 올바르게 업데이트되는지 확인.
        *   전직 시 스탯 보정 및 자동 스킬 습득이 2차/3차 직업 기준으로 올바르게 처리되는지 확인.
    *   트랜잭션 원자성 확인.
    *   DB에 추가된 2차/3차 직업 및 스킬 데이터의 정합성 확인 (요구 레벨, 티어, 관계 등).

---
